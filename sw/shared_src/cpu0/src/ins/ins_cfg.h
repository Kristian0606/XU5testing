//   _____ _____ _____
//  |   | |__   |   | | cpu0/ins/ins.c
//  | | | |   __| | | | Nikolai Nymo
//  |_|___|_____|_|___| 17-04-19
#ifndef SRC_INS_INS_CFG_H_
#define SRC_INS_INS_CFG_H_

#define INS_BUF_SIZE           200U
#define INS_BAUD_DEFAULT       115200U
#define INS_CMD_ASYNC_OFF      "$VNASY,0*XX\n"
#define INS_CMD_ASYNC_OFF_LEN  12U
#define INS_CMD_ASYNC_ON       "$VNASY,1*XX\n"
#define INS_CMD_ASYNC_ON_LEN   12U
#define INS_CMD_ASYNC_NONE     "$VNWRG,6,0,1*XX\n"
#define INS_CMD_ASYNC_NONE_LEN 16U

#define INS_BAUD               921600
#define INS_CMD_SET_BAUD       "$VNWRG,5,921600,1*1FA4\n"
#define INS_CMD_SET_BAUD_LEN   23U

#define INS_CMD_SET_MSG        "$VNWRG,75,1,2,7B,526A,0200,0018,0141,0608,0018*7E96\n" // 400 Hz
#define INS_CMD_SET_MSG_LEN    52U
#define INS_MSG_LEN            157U
#define INS_MSG_HEADER_LEN     14U
#define INS_CRC_LEN            2U

#define INS_TIME_GPS           (INS_MSG_HEADER_LEN + 0U)
#define INS_YAW                (INS_TIME_GPS + 8U)
#define INS_PITCH              (INS_YAW + 4U)
#define INS_ROLL               (INS_PITCH + 4U)
#define INS_ROLL_RATE          (INS_ROLL + 4U)
#define INS_PITCH_RATE         (INS_ROLL_RATE + 4U)
#define INS_YAW_RATE           (INS_PITCH_RATE + 4U)
#define INS_LAT                (INS_YAW_RATE + 4U)
#define INS_LON                (INS_LAT + 8U)
#define INS_ALT                (INS_LON + 8U)
#define INS_AX_RAW             (INS_ALT + 8U)
#define INS_AY_RAW             (INS_AX_RAW + 4U)
#define INS_AZ_RAW             (INS_AY_RAW + 4U)
#define INS_ROLL_RATE_RAW      (INS_AZ_RAW + 4U)
#define INS_PITCH_RATE_RAW     (INS_ROLL_RATE_RAW + 4U)
#define INS_YAW_RATE_RAW       (INS_PITCH_RATE_RAW + 4U)
#define INS_INS_STATUS         (INS_YAW_RATE_RAW + 4U)
#define INS_TIME_GPS_PPS       (INS_INS_STATUS + 2U)
#define INS_TIME_STATUS        (INS_TIME_GPS_PPS + 8U)
#define INS_GNSS_A_SATS        (INS_TIME_STATUS + 1U)
#define INS_GNSS_A_FIX         (INS_GNSS_A_SATS + 1U)
#define INS_AHRS_STATUS        (INS_GNSS_A_FIX + 1U)
#define INS_AX                 (INS_AHRS_STATUS + 2U)
#define INS_AY                 (INS_AX + 4U)
#define INS_AZ                 (INS_AY + 4U)
#define INS_YAW_STD            (INS_AZ + 4U)
#define INS_PITCH_STD          (INS_YAW_STD + 4U)
#define INS_ROLL_STD           (INS_PITCH_STD + 4U)
#define INS_VX                 (INS_ROLL_STD + 4U)
#define INS_VY                 (INS_VX + 4U)
#define INS_VZ                 (INS_VY + 4U)
#define INS_POS_STD            (INS_VZ + 4U)
#define INS_VEL_STD            (INS_POS_STD + 4U)
#define INS_GNSS_B_SATS        (INS_VEL_STD + 4U)
#define INS_GNSS_B_FIX         (INS_GNSS_B_SATS + 1U)

/* Antenna Positions:
 * See revolvevault.ivt.ntnu.no:8090/display/EL/Installation+and+Configuration
 */
#define ANTENNA_REAR_HEAD_RESTRAINT

#if defined(ANTENNA_REAR_MAIN_HOOP)
#define INS_CMD_COMPASS_BASELINE     "$VNWRG,93,+0.000,+1.199,+0.529,+0.02,+0.02,+0.02*XX\n"
#define INS_CMD_COMPASS_BASELINE_LEN 52U
#define INS_CMD_ANT_A_OFFSET         "$VNWRG,57,+0.000,-0.342,-1.019*XX\n"
#define INS_CMD_ANT_A_OFFSET_LEN     34U
#elif defined(ANTENNA_REAR_HEAD_RESTRAINT)
#define INS_CMD_COMPASS_BASELINE     "$VNWRG,93,+0.000,+1.333,+0.267,+0.02,+0.02,+0.02*XX\n"
#define INS_CMD_COMPASS_BASELINE_LEN 52U
#define INS_CMD_ANT_A_OFFSET         "$VNWRG,57,+0.000,-0.476,-0.757*XX\n"
#define INS_CMD_ANT_A_OFFSET_LEN     34U
#endif

/* Compass Baseline Calibration:
 *
 */
#define INS_CMD_GET_CALIB     "$VNRRG,97*7D\n"
#define INS_CMD_GET_CALIB_LEN 13U

/* Macros for deriving INS filter state.
 * See INS Filter Mode in INS status field.
 */
#define INS_FIL_MASK     0b0000000000000011
#define INS_FIL_ALIGNING 0b0000000000000001
#define INS_FIL_TRACKING 0b0000000000000010

/*--------------------------------------+-----------------------------------------------------------+
|    GPS Time - GPS Epoch 1980 - [ns]   |                      Attitude - [deg]                     |
+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+
| 14 | 15 | 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 | 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 | 32 | 33 |
+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+
|                  u64                  |        f32        |        f32        |        f32        |
+---------------------------------------+-------------------+-------------------+-------------------+
|                TimeGps                |        Yaw        |       Pitch       |        Roll       |
+---------------------------------------+-------------------+-------------------+-------------------+

+-----------------------------------------------------------+
|             Angular Rate - Compensated - [rad/s]          |
+----+----+----+----+----+----+----+----+----+----+----+----+
| 34 | 35 | 36 | 37 | 38 | 39 | 40 | 41 | 42 | 43 | 44 | 45 |
+----+----+----+----+----+----+----+----+----+----+----+----+
|        f32        |        f32        |        f32        |
+-------------------+-------------------+-------------------+
|     Roll rate     |     Pitch rate    |      Yaw rate     |
+-------------------+-------------------+-------------------+

+-----------------------------------------------------------------------------------------------------------------------+
|                                             Position - LLA - [deg, deg, m]                                            |
+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+
| 46 | 47 | 48 | 49 | 50 | 51 | 52 | 53 | 54 | 55 | 56 | 57 | 58 | 59 | 60 | 61 | 62 | 63 | 64 | 65 | 66 | 67 | 68 | 69 |
+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+
|                  f64                  |                  f64                  |                  f64                  |
+---------------------------------------+---------------------------------------+---------------------------------------+
|                Latitude               |               Longitude               |                Altitude               |
+---------------------------------------+---------------------------------------+---------------------------------------+

+-----------------------------------------------------------+-----------------------------------------------------------+
|         Linear Acceleration - Compensated - [m/s^2]       |            Linear Acceleration - Raw - [m/s^2]            |
+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+
| 70 | 71 | 72 | 73 | 74 | 75 | 76 | 77 | 78 | 79 | 80 | 81 | 82 | 83 | 84 | 85 | 86 | 87 | 88 | 89 | 90 | 91 | 92 | 93 |
+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+
|        f32        |        f32        |        f32        |        f32        |        f32        |        f32        |
+-------------------+-------------------+-------------------+-------------------+-------------------+-------------------+
|         Ax        |         Ay        |         Az        |         Ax        |         Ay        |         Az        |
+-------------------+-------------------+-------------------+-------------------+-------------------+-------------------+

+-----------------------------------------------------------------+
|                   Angular Rate - Raw - [rad/s]                  |
+----+----+----+----+----+----+-----+-----+-----+-----+-----+-----+
| 94 | 95 | 96 | 97 | 98 | 99 | 100 | 101 | 102 | 103 | 104 | 105 |
+----+----+----+----+----+----+-----+-----+-----+-----+-----+-----+
|        f32        |         f32         |          f32          |
+-------------------+---------------------+-----------------------+
|     Roll rate     |      Pitch rate     |        Yaw rate       |
+-------------------+---------------------+-----------------------+

+------------+-----------------------------------------------+-------------+------------------------------+--------------+
| INS status |              Time GPS PPS - [ns]              | Time Status |       GNSS A - NumSats       | GNSS A - Fix |
+------+-----+-----+-----+-----+-----+-----+-----+-----+-----+-------------+------------------------------+--------------+
|  106 | 107 | 108 | 109 | 110 | 111 | 112 | 113 | 114 | 115 |     116     |              117             |      118     |
+------+-----+-----+-----+-----+-----+-----+-----+-----+-----+-------------+------------------------------+--------------+
|     u16    |                      u64                      |      u8     |              u8              |      u8      |
+------------+-----------------------------------------------+-------------+------------------------------+--------------+
|  See table |                                               |  See table  | Number of tracked satellites |   See table  |
+------------+-----------------------------------------------+-------------+------------------------------+--------------+

+-----------------------------------------------------------------------+-----------------------------------------------------------------------+
|          Attitude Uncertainty - 1 standard deviation - [deg]          |                     Linear Velocity - Body - [m/s]                    |
+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
| 119 | 120 | 121 | 122 | 123 | 124 | 125 | 126 | 127 | 128 | 129 | 130 | 131 | 132 | 133 | 134 | 135 | 136 | 137 | 138 | 139 | 140 | 141 | 142 |
+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
|          f32          |          f32          |          f32          |          f32          |          f32          |          f32          |
+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+
|        Yaw std        |       Pitch std       |        Roll std       |           Vx          |           Vy          |           Vz          |
+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+

+---------------------------------------------------+-----------------------------------------------------+------------------------------+--------------+
| Position Uncertainty - 1 standard deviation - [m] | Velocity Uncertainty - 1 standard deviation - [m/s] |       GNSS B - NumSats       | GNSS B - Fix |
+------------+------------+------------+------------+-------------+-------------+------------+------------+------------------------------+--------------+
|     143    |     144    |     145    |     146    |     147     |     148     |     149    |     150    |              151             |      152     |
+------------+------------+------------+------------+-------------+-------------+------------+------------+------------------------------+--------------+
|                        f32                        |                         f32                         |              u8              |      u8      |
+---------------------------------------------------+-----------------------------------------------------+------------------------------+--------------+
|   Pos std (same estimate for all NED directions)  |                Absolute velocity std                | Number of tracked satellites |   See table  |
+---------------------------------------------------+-----------------------------------------------------+------------------------------+--------------+

INS Status Table
+---------------+------------+-------------------+------------------------------------+
| Name          | Bit offset | Value             | Description                        |
+---------------+------------+-------------------+------------------------------------+
| Mode          | 0:1        | 0                 | Not tracking                       |
+---------------+------------+-------------------+------------------------------------+
|               |            | 1                 | Aligning                           |
+---------------+------------+-------------------+------------------------------------+
|               |            | 2                 | Tracking                           |
+---------------+------------+-------------------+------------------------------------+
|               |            | 3                 | Loss of GNSS                       |
+---------------+------------+-------------------+------------------------------------+
| GpsFix        | 2:2        | 1                 | Has proper fix                     |
+---------------+------------+-------------------+------------------------------------+
| Error         | 3:6        | See "Error table" |                                    |
+---------------+------------+-------------------+------------------------------------+
| Reserved      | 7:7        |                   |                                    |
+---------------+------------+-------------------+------------------------------------+
| GpsHeadingIns | 8:8        | 1                 | INS filter aligned to GNSS compass |
+---------------+------------+-------------------+------------------------------------+
| GpsCompass    | 9:9        | 1                 | GNSS compass is operational        |
+---------------+------------+-------------------+------------------------------------+
| Reserved      | 10:15      |                   |                                    |
+---------------+------------+-------------------+------------------------------------+

Error table
+----------------+------------+-------+---------------------------------------+
| Name           | Bit offset | Value | Description                           |
+----------------+------------+-------+---------------------------------------+
| Reserved       | 0:0        |       |                                       |
+----------------+------------+-------+---------------------------------------+
| IMU Error      | 1:1        | 1     | IMU communication error               |
+----------------+------------+-------+---------------------------------------+
| Mag/Pres Error | 2:2        | 1     | Magnetometer or Pressure sensor error |
+----------------+------------+-------+---------------------------------------+
| GNSS error     | 3:3        | 1     | GNSS communication error              |
+----------------+------------+-------+---------------------------------------+

Time Status table
+--------------+------------+-------+-------------------------------+
| Name         | Bit offset | Value | Description                   |
+--------------+------------+-------+-------------------------------+
| timeOk       | 0:0        | 1     | GpsTow is valid               |
+--------------+------------+-------+-------------------------------+
| dateOk       | 1:1        | 1     | TimeGps and GpsWeek are valid |
+--------------+------------+-------+-------------------------------+
| utcTimeValis | 2:2        | 1     | UTC time is valid             |
+--------------+------------+-------+-------------------------------+
| reserved     | 3:7        |       |                               |
+--------------+------------+-------+-------------------------------+

GNSS Fix Table
+----------+-------+-------------+
| Name     | Value | Description |
+----------+-------+-------------+
| GNSS Fix | 0     | No fix      |
+----------+-------+-------------+
|          | 1     | Time only   |
+----------+-------+-------------+
|          | 2     | 2D          |
+----------+-------+-------------+
|          | 3     | 3D          |
+----------+-------+-------------+
|          | 4     | SBAS        |
+----------+-------+-------------+
|          | 7     | RTK Float   |
+----------+-------+-------------+
|          | 8     | RTK Fixed   |
+----------+-------+-------------+*/

#endif /* SRC_INS_INS_CFG_H_ */
